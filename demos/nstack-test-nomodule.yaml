# Tests that require no modules to be built and are therefore fast to run
module_dirs: []

tests:
  - name: demo_tsv
    notebook: |
      import BuiltinServices:0.0.1-SNAPSHOT as N
      Sources.http<Text> { http_path = "/tsv" } | N.from_csv<[Integer]> {csv_sep="\t"} | N.to_csv<[Integer]> {csv_sep="!"} | N.log<Text>
    cmds:
      - cmd: send
        endpoint: /tsv
        data: "1\t2\t42"
      - { cmd: sleep, secs: 2 }
      - cmd: log_sink
        regex: \"1!2!42\"

  - name: from_tsv_file
    notebook: |
      import BuiltinServices:0.0.1-SNAPSHOT as N
      Sources.http<Text> { http_path = "/tsv" } | N.from_csv<[[Integer]]> {csv_sep="\t"} | N.to_json<[[Integer]]> | N.log<Text>
    cmds:
      - cmd: send
        endpoint: /tsv
        data: "1\t2\t42\n3\t4\t15\n"
      - { cmd: sleep, secs: 2 }
      - cmd: log_sink
        regex: |
          "\[\[1,2,42\],\[3,4,15\]\]"\s*

  - name: to_csv_file
    notebook: |
      import BuiltinServices:0.0.1-SNAPSHOT as N
      Sources.http<[{a:Integer,b:Boolean}]> { http_path = "/tsv" } | N.to_csv<[{a:Integer,b:Boolean}]> | N.log<Text>
    cmds:
      - cmd: send
        endpoint: /tsv
        data:
          [{"b":false, "a":1}, {"a":-1,"b":true}]
      - { cmd: sleep, secs: 2 }
      - cmd: log_sink
        regex: |
          "a,b\\r\\n1,FALSE\\r\\n-1,TRUE\\r\\n"\s*

  - name: builtin_services
    notebook: |
      import BuiltinServices:0.0.1-SNAPSHOT as N
      N.http{http_path="/log"} | N.log<(Double,{romeo:Integer,juliet:Boolean})>
    cmds: []
